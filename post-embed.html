<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Blogger Post Embed</title>

<style>
body {
  font-family: Helvetica, Arial, sans-serif;
  margin: 0;
}

#card {
  border: 1px solid #ddd;
  padding: 14px;
}

img {
  max-width: 100%;
  height: auto;
  display: block;
  margin-bottom: 12px;
}

h3 {
  font-size: 1.1rem;
  font-weight: normal;
  margin: 0 0 8px 0;
}

h3 a {
  color: inherit;
  text-decoration: none;
}

h3 a:hover {
  text-decoration: underline;
}

.date {
  font-size: 0.75rem;
  color: #666;
  margin-bottom: 10px;
}

p {
  font-size: 0.95rem;
  line-height: 1.4;
  margin: 0;
}
</style>
</head>

<body>

<div id="card">Loading post…</div>

<script>
const FEED_BASE =
  "https://moroccantapestash.blogspot.com/feeds/posts/default" +
  "?alt=json-in-script&max-results=500&callback=show";

const targetURL =
  new URLSearchParams(window.location.search).get("url");

const yearsToTry = [
  null,
  "2018-01-01T00:00:00Z",
  "2015-01-01T00:00:00Z",
  "2012-01-01T00:00:00Z"
];

let attempt = 0;

function loadNextFeed() {
  if (attempt >= yearsToTry.length) {
    document.getElementById("card").textContent = "Post not found.";
    return;
  }

  let src = FEED_BASE;
  if (yearsToTry[attempt]) {
    src += "&updated-max=" + encodeURIComponent(yearsToTry[attempt]);
  }

  attempt++;

  const s = document.createElement("script");
  s.src = src;
  document.body.appendChild(s);
}

function show(feed) {
  const entries = feed.feed.entry || [];
  const post = entries.find(e =>
    e.link.some(l => l.rel === "alternate" && l.href === targetURL)
  );

  if (!post) {
    loadNextFeed();
    return;
  }

  // ---- RENDER LOGIC (RESTORED) ----

  const doc = new DOMParser().parseFromString(post.content.$t, "text/html");

  const img = doc.querySelector("img");
  doc.querySelectorAll("img").forEach(i => i.remove());

  let text = "";
  for (const el of doc.body.querySelectorAll("p, div, span")) {
    const t = el.textContent.replace(/\s+/g, " ").trim();
    if (t.length > 40) { text = t; break; }
  }

  if (text.length > 220) {
    text = text.slice(0, 220).trim() + "…";
  }

  const isRTL = /[\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC]/.test(text);
  const dir = isRTL ? "rtl" : "ltr";

  const dateStr = new Date(post.published.$t).toLocaleDateString(undefined, {
    year: "numeric",
    month: "short",
    day: "numeric"
  });

  document.getElementById("card").innerHTML = `
    ${img ? `<img src="${img.src}">` : ""}
    <h3><a href="${targetURL}" target="_blank" rel="noopener">
      ${post.title.$t}
    </a></h3>
    <div class="date">${dateStr}</div>
    <p dir="${dir}">${text}</p>
  `;
}

// Start the paging process
loadNextFeed();
</script>

</body>
</html>
